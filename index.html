<!DOCTYPE html> 
<html> 
<head> 
    <title></title>
    <script src="jq/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="jq/jquery.mobile-1.3.0.js" type="text/javascript"></script>
    <link rel="stylesheet" href="jq/jquery.mobile-1.3.0.css">
    <link rel="stylesheet" href="favs.css">
</head>
<body>

<div data-role="page" id="page1">
    <div data-role="header">
        <h1>Home Page</h1>
    </div>
    <div data-role="content">
        <ul id="items1" data-role="listview">
          <!-- dynamic items goes here. -->  
        </ul>
    </div>
    <div data-role="footer">
            <h4>Page Footer</h4>
    </div>
</div>

<!--  nav bar
    <div data-role="navbar">
        <ul>
            <li><a href="#" data-icon="arrow-l" data-iconpos="left">Prev Page</a></li>
            <li><a href="#">Two</a></li>
            <li><a href="#" data-icon="arrow-r" data-iconpos="right" >Next Page</a></li>
        </ul>
    </div>

-->

<script language="javascript" type="text/javascript">

    function htmlifyTweet (tweet) {
        urls = tweet.entities.urls;
        text = tweet.text;
        offset = 0;
        for (i in urls) {
            url = urls[i];
            link = "<a href='" + url.url + "' target='_blank'>" + url.url + "</a>";
            text = text.substr(0, url.indices[0]+offset) + link + text.substr(url.indices[1]+offset);
            console.log(url.indices[0]+offset);
            console.log(url.indices[1]+url.url.length+offset);
            offset = link.length - url.url.length;
        }
        return text;
    }

    /*  Create a page for every fav tweet and append to body.
        Page is located at "#p + tweet_id".  ex) index.html#p311975360667459585 */
    function createTweetPage (fav_tweet) {
        var phtml='';
        phtml+='<div data-role="page" id="p' + fav_tweet.id_str + '">';
        phtml+='<div data-role="header">';
        phtml+='<h1>More Info</h1>';
        phtml+='</div>';

        // Page content
        phtml+='<div data-role="content">';
        phtml+='<h2>' + fav_tweet.user.name+ '</h2>';
        phtml+='<p> <b>Twitter id:</b> ' + fav_tweet.user.screen_name +'</p>';
        phtml+='<p> <b>Created at:</b> ' + fav_tweet.created_at +'</p>';
        phtml+='<p> <b>Text:</b> ' + htmlifyTweet(fav_tweet) +'</p>';
        
        media = fav_tweet.entities.media;
        if (media) {
            phtml+='<p> <b>Images:</b> '
            for (i in media) phtml += '<br /><img src="' + media[i].media_url + '" />';
            phtml+='</p>';
        }

        phtml+='<p> <b>Retweeted count:</b> ' + fav_tweet.retweet_count +'</p>';

        // Back button
        phtml+='<p><a href="#" data-rel="back" data-role="button" data-inline="true" data-icon="back">Previous Page</a></p>';
        phtml+='</div>';
        phtml+='</div>';

        $('body').append(phtml);
    }

    /*  Create a new list page.
        Page is located at "#page + page_number".  ex) index.html#page2 */
    function createListPage (page_number) {
        var phtml='';
        phtml+='<div data-role="page" id="page' + page_number + '">';
        phtml+='<div data-role="header">';
        phtml+='<h1>Home Page (' + page_number + ')</h1>';
        phtml+='</div>';
        phtml+='<div data-role="content">';
        phtml+='<ul id="items' + page_number + '" data-role="listview">';
        phtml+='</ul>';
        phtml+='</div>';
        phtml+='<div data-role="footer">';
        phtml+='<h4>Page Footer</h4>';
        phtml+='</div>';
        phtml+='</div>';
        $('body').append(phtml);
    }

    // Read tweets from file "favs.json"
    // CHANGED TO 'favs109' JUST FOR TESTING, CHANGE BACK TO favs.json WHEN DONE
    $.getJSON('favs109.json', function (data) {
        var currentPage = 1;
        var currentItem = 0;
        var itemsPerPage = 9;
        var fav_tweet;

        // Loop through each favourite tweet
        $.each(data, function () {
            fav_tweet = this;
            
            // Find and create appropiate the page
            currentItem += 1;
            if (currentItem > itemsPerPage) {
                currentPage += 1;
                currentItem = 1;
                // Create a new list page
                createListPage(currentPage);
            }

            // Create a new page for every fav tweet
            createTweetPage(fav_tweet);

            // Append to page list
            var shtml='';    
            shtml=shtml+'<li><a href=\"#\">';
            shtml=shtml+'<img src=\"'+fav_tweet.user.profile_image_url+'\" />';

            shtml=shtml+'<h3>'+fav_tweet.user.name+'</h3>';
            shtml=shtml+'<p>'+ fav_tweet.text+'</p>';
            shtml=shtml+'</a><a href="#p' + fav_tweet.id_str + '">More Info</a>';
            shtml=shtml+'</li>';
            $('#items' + currentPage).append(shtml).trigger('create');
        });

        // I am not sure how, but just refreshing the first page also refreshes all the pages
        $('#items1').listview("refresh");
    });
</script>
</body>
</html>
